
    <% if @students.present? %>
      <%= paginate @students %>
      <% students_grouped = @students.includes(:courses).flat_map { |student| student.courses.map { |course| [course, student] } }
                              .group_by(&:first)
                              .transform_values { |pairs| pairs.map(&:last) } %>

      <% students_grouped.each do |course, students| %>
        <% next unless course %>

        <div class="course-header d-flex justify-content-between align-items-center mb-2">
          <h2 class="m-0"><%= course.name %></h2>
          <div class="course-actions d-flex gap-2">
            <%= link_to "âœï¸", edit_course_path(course), data: { turbo: false }, class: "btn btn-sm btn-outline-primary me-2" %>
            <%= link_to course, method: :delete, data: { confirm: "Are you sure you want to delete this course?" }, class: "delete-icon", title: "Delete Course" do %>
              ğŸ—‘ï¸
            <% end %>
          </div>
        </div>

        <div class="cards-container d-flex flex-wrap gap-3 mb-5">
          <% students.each do |student| %>
            <div class="card card-large" style="width: 15rem;">
              <% if student.profile_picture.attached? %>
                <%= image_tag student.profile_picture.variant(resize_to_limit: [400, 400]).processed, class: "card-img-top" %>
              <% else %>
                <%= image_tag "default-profile.png", class: "card-img-top" %>
              <% end %>

              <div class="card-body">
                <p class="course-code"><%= course.name %></p>
                <h6><%= student.first_name %> <%= student.last_name %></h6>
                <div class="mt-3 d-flex justify-content-between">
                  <%= link_to 'Edit', edit_student_path(student), class: "btn btn-warning btn-sm" %>
                  <%= link_to 'Delete', confirm_destroy_student_path(student), class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <%= paginate @students %>

    <% else %>
      <p class="text-center text-muted mt-5">No Students or Course Found matching that criteria.</p>
    <% end %>